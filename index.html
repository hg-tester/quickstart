<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello Analytics Reporting API V4</title>
  <meta name="google-signin-client_id" content="1021175704075-p2s3ou625mi96otfqmer2dv9docs396n.apps.googleusercontent.com">
  <meta name="google-signin-scope" content="https://www.googleapis.com/auth/analytics.readonly">
</head>
<body>

<h1>Hello Analytics Reporting API V4</h1>

<!-- The Sign-in button. This will run `queryReports()` on success. -->
<p class="g-signin2" data-onsuccess="queryReports"></p>

<!-- The API response will be printed here. -->
<textarea cols="80" rows="20" id="query-output"></textarea>
<h3>Date Range</h3>
<textarea cols="40" rows="2" id="date-output"></textarea>
<h3>Total Log In Time</h3>
<textarea cols="40" rows="2" id="total-time-output"></textarea>
<h3>Total # of Sessions</h3>
<textarea cols="40" rows="2" id="total-sessions-output"></textarea>
<h3>Avg. Session Length</h3>
<textarea cols="40" rows="2" id="avg-sessions-output"></textarea>
<h3>Usage by User ID</h3>
<textarea cols="40" rows="2" id="userid-output"></textarea>
<h3 id="usage-log-output">Usage Log</h3>


<script>
  // Replace with your view ID.
  var VIEW_ID = '192100723';

  function queryReports() {
    getUsageLog();
    testReport();
  }

  function getUsageLog() {
    gapi.client.request({
      path: '/v4/reports:batchGet',
      root: 'https://analyticsreporting.googleapis.com/',
      method: 'POST',
      body: {
        reportRequests: [
          {
            viewId: VIEW_ID,
            dateRanges: [
              {
                startDate: '7daysAgo',
                endDate: 'today'
              }
            ],
            metrics: [
              {
                expression: 'ga:sessionDuration'
              }
            ],
            dimensions: [
              {
                name: 'ga:dimension1',
              },
              {
                name: 'ga:eventCategory',
              },
              {
                name: 'ga:dateHourMinute',
              }
            ],
            dimensionFilterClauses: [
              {
                filters: [
                  {
                    dimensionName: "ga:eventCategory",
                    operator: "EXACT",
                    expressions: ["LOGIN"]
                  }
                ]
              }
            ]
          }
        ]
      }
    }).then(displayUsageLog, console.error.bind(console));
  }

  function displayUsageLog(response) {
    const entries = response.result.reports[0].data.rows;

    // create a table
    const table = document.createElement('table');
    table.style.width = '50%';
    table.setAttribute('border', '1');
    const tableBody = document.createElement('tbody');
    table.appendChild(tableBody);

    // set the col headers
    const firstRow = document.createElement('tr');
    const headers = ["Date", "Time (PST)", "Duration", "User ID"];
    for (let i = 0; i < headers.length; i += 1) {
      let temp = document.createElement('th');
      temp.innerText = headers[i];
      firstRow.appendChild(temp);
    }
    tableBody.appendChild(firstRow);

    // fill the table with the correct data
    // for every entry
    for (let i = 0; i <= entries.length; i += 1) {
      // start a new row
      for (let i = 0; i < headers.length; i += 1) {
        let newRow = document.createElement('tr');
        let data = document.createElement('td');
        let cellData = null;
        if (i === 0) {
          // date
          cellData = `${entries[i].dimensions[2].slice(4,6)}/${entries[i].dimensions[2].slice(6,8)}/${entries[i].dimensions[2].slice(2,4)}}`
        }
        else if (i === 1) {
          // time
          cellData = `${parseInt(entries[i].dimensions[2].slice(8,10)) - 1}:${parseInt(entries[i].dimensions[2].slice(10))}:00`
        }
        else if (i === 2) {
          // duration
          cellData = convertSecondsToTimestamp(parseInt(entries[i].metrics[0].values[0])
        }
        else if (i === 3) {
          // user
          cellData = entries[i].dimensions[0]
        }
        data.innerText = cellData
        newRow.appendChild(data)
        tableBody.appendChild(newRow);
      }
    }
    console.log("USAGE LOG: ", response);
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('usage-log-output').appendChild(table);
  }

  // Query the API and print the results to the page.
  function testReport() {
    gapi.client.request({
      path: '/v4/reports:batchGet',
      root: 'https://analyticsreporting.googleapis.com/',
      method: 'POST',
      body: {
        reportRequests: [
          {
            viewId: VIEW_ID,
            dateRanges: [
              {
                startDate: '7daysAgo',
                endDate: 'today'
              }
            ],
            metrics: [
              {
                expression: 'ga:sessions'
              },
              {
                expression: 'ga:sessionDuration'
              },
              {
                expression: 'ga:avgSessionDuration'
              },
              {
                expression: 'ga:metric1'
              },
            ],
            dimensions: [
              {
                name: 'ga:dimension1',
              },
              {
                name: 'ga:eventCategory',
              }
            ]
          }
        ]
      }
    }).then(displayResults, console.error.bind(console));
  }

  function displayResults(response) {
    console.log(response);
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').value = formattedJson;
  }
  function convertSecondsToTimestamp (seconds) {
    return new Date(seconds * 1000).toISOString().substr(11, 8)
  }
</script>

<!-- Load the JavaScript API client and Sign-in library. -->
<script src="https://apis.google.com/js/client:platform.js"></script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello Analytics Reporting API V4</title>
  <meta name="google-signin-client_id" content="1021175704075-p2s3ou625mi96otfqmer2dv9docs396n.apps.googleusercontent.com">
  <meta name="google-signin-scope" content="https://www.googleapis.com/auth/analytics.readonly">
</head>
<body>

<h1>Hello Analytics Reporting API V4</h1>

<!-- The Sign-in button. This will run `queryReports()` on success. -->
<p class="g-signin2" data-onsuccess="queryReports"></p>

<!-- The API response will be printed here. -->
<h3>Date Range: </h3>
<form onsubmit="return updateDate();">
  Start Date: <input type="date" name="start" id="startDate" value="value">
  End Date: <input type="date" name="end" id="endDate" value="value">
  <input type="submit">
</form>
<h3 id="overview">Overview</h3>
<h3 id="userid-output">Usage by User ID</h3>
<h3 id="usage-log-output">Usage Log</h3>


<script>
  // Replace with your view ID.
  var VIEW_ID = '192100723';

  function updateDate() {
    const start = document.getElementById('startDate').value
    const end = document.getElementById('endDate').value
    queryReports(start, end)
    return false;
  }

  function queryReports(start, end) {
    console.log(typeof start, typeof end)
    overviewStats();
    usageByUserId();
    getUsageLog();
  }
  function overviewStats() {
    gapi.client.request({
      path: '/v4/reports:batchGet',
      root: 'https://analyticsreporting.googleapis.com/',
      method: 'POST',
      body: {
        reportRequests: [
          {
            viewId: VIEW_ID,
            dateRanges: [
              {
                startDate: '7daysAgo',
                endDate: 'today'
              }
            ],
            metrics: [
              {
                expression: 'ga:sessions'
              },
              {
                expression: 'ga:sessionDuration'
              },
              {
                expression: 'ga:avgSessionDuration'
              }
            ],
          }
        ]
      }
    }).then(displayOverview, console.error.bind(console));
  }
  function displayOverview (response) {
    const entries = response.result.reports[0].data.rows;
    // check for an existing table
    const existingTable = document.getElementById('display-overview');
    if (existingTable) {
      existingTable.parentNode.removeChild(existingTable);
    }
    // create a table
    const table = document.createElement('table');
    table.style.width = '50%';
    table.setAttribute('border', '1');
    table.setAttribute('id', 'display-overview');
    const tableBody = document.createElement('tbody');
    table.appendChild(tableBody);

    // set the col headers
    const firstRow = document.createElement('tr');
    const headers = ["Total Log-In Time", "Total # of Sessions", "Avg. Session Length"];
    for (let i = 0; i < headers.length; i += 1) {
      let temp = document.createElement('th');
      temp.innerText = headers[i];
      firstRow.appendChild(temp);
    }
    tableBody.appendChild(firstRow);

    for (let i = 0; i < entries.length; i += 1) {
      // start a new row
      let newRow = document.createElement('tr');
      for (let j = 0; j < headers.length; j += 1) {
        let data = document.createElement('td');
        let cellData = null;
        if (j === 0) {
          // total log in time
          cellData = convertSecondsToTimestamp(parseInt(entries[i].metrics[0].values[1]));
        }
        else if (j === 1) {
          // total # of sessions
          cellData = entries[i].metrics[0].values[0];
        }
        else if (j === 2) {
          // avg session length
          cellData = convertSecondsToTimestamp(parseInt(entries[i].metrics[0].values[2]));
        }
        // appened 
        data.innerText = cellData;
        newRow.appendChild(data);
      }
      tableBody.appendChild(newRow);
    }
    document.getElementById('overview').appendChild(table);
  }
  // get usage by user id
  function usageByUserId () {
    gapi.client.request({
      path: '/v4/reports:batchGet',
      root: 'https://analyticsreporting.googleapis.com/',
      method: 'POST',
      body: {
        reportRequests: [
          {
            viewId: VIEW_ID,
            dateRanges: [
              {
                startDate: '7daysAgo',
                endDate: 'today'
              }
            ],
            metrics: [
              {
                expression: 'ga:sessionDuration'
              },
              {
                expression: 'ga:sessions'
              }
            ],
            dimensions: [
              {
                name: 'ga:dimension1',
              },
            ],
          }
        ]
      }
    }).then(displayUsageByUserId, console.error.bind(console));
  }
  // render usage by user id
  function displayUsageByUserId (response) {
    const entries = response.result.reports[0].data.rows;

    // create a table
    const table = document.createElement('table');
    table.style.width = '50%';
    table.setAttribute('border', '1');
    const tableBody = document.createElement('tbody');
    table.appendChild(tableBody);

    // set the col headers
    const firstRow = document.createElement('tr');
    const headers = ["User ID", "Total Usage", "Sessions"];
    for (let i = 0; i < headers.length; i += 1) {
      let temp = document.createElement('th');
      temp.innerText = headers[i];
      firstRow.appendChild(temp);
    }
    tableBody.appendChild(firstRow);

    for (let i = 0; i < entries.length; i += 1) {
      // start a new row
      let newRow = document.createElement('tr');
      for (let j = 0; j < headers.length; j += 1) {
        let data = document.createElement('td');
        let cellData = null;
        if (j === 0) {
          // user
          // somehow get the email out of the hash value eventually
          cellData = entries[i].dimensions[0];
        }
        else if (j === 1) {
          // total usage
          cellData = convertSecondsToTimestamp(entries[i].metrics[0].values[0]);
        }
        else if (j === 2) {
          // sessions count
          cellData = entries[i].metrics[0].values[1];
        }
        // appened 
        data.innerText = cellData;
        newRow.appendChild(data);
      }
      tableBody.appendChild(newRow);
    }
    document.getElementById('userid-output').appendChild(table);
  }
  // get usage log
  function getUsageLog() {
    gapi.client.request({
      path: '/v4/reports:batchGet',
      root: 'https://analyticsreporting.googleapis.com/',
      method: 'POST',
      body: {
        reportRequests: [
          {
            viewId: VIEW_ID,
            dateRanges: [
              {
                startDate: '7daysAgo',
                endDate: 'today'
              }
            ],
            metrics: [
              {
                expression: 'ga:sessionDuration'
              }
            ],
            dimensions: [
              {
                name: 'ga:dimension1',
              },
              {
                name: 'ga:eventCategory',
              },
              {
                name: 'ga:dateHourMinute',
              }
            ],
            dimensionFilterClauses: [
              {
                filters: [
                  {
                    dimensionName: "ga:eventCategory",
                    operator: "EXACT",
                    expressions: ["LOGIN"]
                  }
                ]
              }
            ]
          }
        ]
      }
    }).then(displayUsageLog, console.error.bind(console));
  }
  // render usage log
  function displayUsageLog(response) {
    const entries = response.result.reports[0].data.rows;

    // create a table
    const table = document.createElement('table');
    table.style.width = '50%';
    table.setAttribute('border', '1');
    const tableBody = document.createElement('tbody');
    table.appendChild(tableBody);

    // set the col headers
    const firstRow = document.createElement('tr');
    const headers = ["Date", "Time (PST)", "Duration", "User ID"];
    for (let i = 0; i < headers.length; i += 1) {
      let temp = document.createElement('th');
      temp.innerText = headers[i];
      firstRow.appendChild(temp);
    }
    tableBody.appendChild(firstRow);

    // fill the table with the correct data
    // for every entry
    for (let i = 0; i < entries.length; i += 1) {
      // start a new row
      let newRow = document.createElement('tr');
      for (let j = 0; j < headers.length; j += 1) {
        let data = document.createElement('td');
        let cellData = null;
        if (j === 0) {
          // date
          cellData = formatDate(entries[i].dimensions[2]);
        }
        else if (j === 1) {
          // time
          cellData = createTimestamp(entries[i].dimensions[2]);
        }
        else if (j === 2) {
          // duration
          cellData = convertSecondsToTimestamp(parseInt(entries[i].metrics[0].values[0]));
        }
        else if (j === 3) {
          // user
          // somehow get the email out of the hash value eventually
          cellData = entries[i].dimensions[0]
        }
        // appened 
        data.innerText = cellData
        newRow.appendChild(data)
      }
      tableBody.appendChild(newRow);
    }
    document.getElementById('usage-log-output').appendChild(table);
  }

  // Query the API and print the results to the page.
  function testReport() {
    gapi.client.request({
      path: '/v4/reports:batchGet',
      root: 'https://analyticsreporting.googleapis.com/',
      method: 'POST',
      body: {
        reportRequests: [
          {
            viewId: VIEW_ID,
            dateRanges: [
              {
                startDate: '7daysAgo',
                endDate: 'today'
              }
            ],
            metrics: [
              {
                expression: 'ga:sessions'
              },
              {
                expression: 'ga:sessionDuration'
              },
              {
                expression: 'ga:avgSessionDuration'
              },
              {
                expression: 'ga:metric1'
              },
            ],
            dimensions: [
              {
                name: 'ga:dimension1',
              },
              {
                name: 'ga:eventCategory',
              }
            ]
          }
        ]
      }
    }).then(displayResults, console.error.bind(console));
  }

  function displayResults(response) {
    console.log(response);
    const formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').value = formattedJson;
  }

  function convertSecondsToTimestamp (seconds) {
    return new Date(seconds * 1000).toISOString().substr(11, 8)
  }

  function createTimestamp (data) {
    // hours
    let hours = parseInt(data.slice(8,10)) - 1
    if (hours > 12) hours = hours - 12
    // minutes
    let minutes = data.slice(10)
    // seconds
    return `${hours}:${minutes}:00`
  }

  function formatDate (data) {
    // month
    let month = data.slice(4,6)
    // day
    let day = data.slice(6,8)
    // year
    let year = data.slice(2,4)

    return `${month}/${day}/${year}`
  }
</script>

<!-- Load the JavaScript API client and Sign-in library. -->
<script src="https://apis.google.com/js/client:platform.js"></script>

</body>
</html>
